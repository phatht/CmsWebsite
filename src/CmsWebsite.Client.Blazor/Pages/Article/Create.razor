@page "/article/create"
@using CmsWebsite.Client.Blazor.Services.Article
@using CmsWebsite.Client.Blazor.Services.Category
@using CmsWebsite.Client.Blazor.Services.ArticleCategory
@using System.Security.Claims
@using CmsWebsite.Share.Models.Article
@using CmsWebsite.Share.Models.ArticleCategory
@using CmsWebsite.Share.Models.Category
@using System.Text.Json

@inject NavigationManager uriHelper
@inject IArticleService _articleService
@inject ICategoryService _categoryService
@inject IArticleCategoryService _acService

@inject NotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
<h3>Create Article</h3>
@*
    TItem: truyền 1 class, đối tượng request để hiển thị dữ liệu
    Data: truyền 1 biến object để bind dữ liệu
    Submit: truyền 1 function
*@

<RadzenTemplateForm TItem="ArticleCreateRequest" Data="@article" Submit=@CreateArticle>
    <div class="row">
        <RadzenFieldset>
            <div class="row">
                <div class="col-md-3 align-items-center d-flex">
                    <RadzenLabel Component="ImageFile" Text="ImageFile" />
                </div>
                <div class="col-md-9">
                    <RadzenFileInput TValue="string" @bind-Value="@article.ImageFile" Class="w-100" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 align-items-center d-flex">
                    <RadzenLabel Component="Title" Text="Title" />
                </div>
                <div class="col-md-9">
                    <RadzenTextBox Name="Title" @bind-Value="@article.Title" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 align-items-center d-flex">
                    <RadzenLabel Component="Description" Text="Description" />
                </div>
                <div class="col-md-9">
                    <RadzenTextBox Name="Description" @bind-Value="@article.Description" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 align-items-center d-flex">
                    <RadzenLabel Component="SummaryArticle" Text="Summary Article" />
                </div>
                <div class="col-md-9">
                    <RadzenHtmlEditor Name="SummaryArticle" @bind-Value=@article.SummaryArticle style="height: 500px; margin-bottom: 1rem;" UploadUrl="upload/image">
                        <RadzenHtmlEditorUndo />
                        <RadzenHtmlEditorRedo />
                        <RadzenHtmlEditorSeparator />
                        <RadzenHtmlEditorBold />
                        <RadzenHtmlEditorItalic />
                        <RadzenHtmlEditorUnderline />
                        <RadzenHtmlEditorStrikeThrough />
                        <RadzenHtmlEditorSeparator />
                        <RadzenHtmlEditorColor />
                        <RadzenHtmlEditorBackground />
                        <RadzenHtmlEditorRemoveFormat />
                    </RadzenHtmlEditor>
                    @*<RadzenTextBox Name="SummaryArticle" @bind-Value="@article.SummaryArticle" />*@
                </div>
            </div>


            <div class="row">
                <div class="col-md-3 align-items-center d-flex">
                    <RadzenLabel Component="KeyWords" Text="KeyWords" />
                </div>
                <div class="col-md-9">
                    <RadzenTextBox Name="KeyWords" @bind-Value="@article.KeyWords" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 align-items-center d-flex">
                    <RadzenLabel Component="SubHead" Text="SubHead" />
                </div>
                <div class="col-md-9">
                    <RadzenTextBox Name="SubHead" @bind-Value="@article.SubHead" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 align-items-center d-flex">
                    <RadzenLabel Component="Categories" Text="Categories" />
                </div>
                <div class="col-md-9">
                    <RadzenDropDown AllowClear=true Name="Level" Data="@Categories" TextProperty="CategoryName" ValueProperty="CategoryId"
                                    @bind-Value=@ac.CategoryID Placeholder="Select Category..." />

                </div>
            </div>

            <div class="row">
                <div class="col-md-3 align-items-center d-flex">
                    <RadzenLabel Component="PublishDate" Text="PublishDate" />
                </div>
                <div class="col-md-9">
                    <RadzenDatePicker @bind-Value=@article.PublishDate TValue="DateTime" ShowTime="true" ShowSeconds="true"
                                      HoursStep="1.5" MinutesStep="5" SecondsStep="10" DateFormat="MM/dd/yyyy HH:mm">
                        <FooterTemplate>
                            <RadzenButton Click=@OnTodayClick Text="Today" />
                        </FooterTemplate>
                    </RadzenDatePicker>
                </div>
            </div>

            <div class="row align-items-end justify-content-center">
                <RadzenButton ButtonType="ButtonType.Submit" Text="Save" />
            </div>
        </RadzenFieldset>
    </div>
</RadzenTemplateForm>

@code {
    private ArticleCreateRequest article = new ArticleCreateRequest()
        {
            PublishDate = DateTime.Now,
        };
    private ArticleCategoryCreateRequest ac = new ArticleCategoryCreateRequest();
    private List<CategoryDTO> Categories { get; set; } = new List<CategoryDTO>();
    protected override async Task OnInitializedAsync()
    {
        article.UserId = await getUserId();
        Categories = await _categoryService.GetListCategory();
    }
    async Task CreateArticle()
    {

        var newArticle = await _articleService.CreateArticle(article);
        if (newArticle != null)
        {
            ac.ArticleID = newArticle;
            var result = await _acService.CreateArticleCategory(ac);
            if (result != null)
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Thông báo sự kiện",
                        Detail = "Thêm thành công",
                        Duration = 4000,
                    });
                uriHelper.NavigateTo("/article");
            }
            else
            {
                Console.WriteLine(JsonSerializer.Serialize(result, new JsonSerializerOptions() { WriteIndented = true }));
            }
        }
        else
        {
            Console.WriteLine(JsonSerializer.Serialize(article, new JsonSerializerOptions() { WriteIndented = true }));
        }
    }
    void OnTodayClick()
    {
        article.PublishDate = DateTime.Now;
    }
    async Task<string> getUserId()
    {
        var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;
        return user.FindFirst(u => u.Type.Contains("UserId"))?.Value;

    }
}
